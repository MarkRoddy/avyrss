# AvyRSS Nginx Configuration
#
# This configuration serves the AvyRSS static files for avyrss.com
#
# Installation:
#   1. Copy this file to /etc/nginx/sites-available/avyrss.com
#   2. Create symlink: sudo ln -s /etc/nginx/sites-available/avyrss.com /etc/nginx/sites-enabled/
#   3. Test config: sudo nginx -t
#   4. Reload nginx: sudo systemctl reload nginx
#
# Prerequisites:
#   - Repository cloned/updated to /var/www/avyrss (via update-feeds.sh)
#   - Files owned by avyrss:www-data (automatic if systemd service runs)
#   - DNS for avyrss.com and www.avyrss.com pointing to this server

# Redirect www to non-www
server {
    listen 80;
    listen [::]:80;

    server_name www.avyrss.com;

    # Redirect to non-www
    return 301 http://avyrss.com$request_uri;
}

# Main server block
server {
    listen 80;
    listen [::]:80;

    server_name avyrss.com;

    # Root directory where AvyRSS files are located
    root /var/www/avyrss;

    # Logging
    access_log /var/log/nginx/avyrss-access.log;
    error_log /var/log/nginx/avyrss-error.log;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Serve index.html at root
    location = / {
        try_files /index.html =404;

        # Cache for 1 hour (forecasts don't change that often)
        add_header Cache-Control "public, max-age=3600";
    }

    # Serve RSS feeds
    location /feed/ {
        # RSS feeds are in feeds/ directory
        # URL: /feed/center/zone maps to feeds/center/zone.xml
        rewrite ^/feed/(.*)$ /feeds/$1.xml break;

        try_files $uri =404;

        # Correct content type for RSS
        types {
            application/rss+xml xml;
        }

        # Cache for 1 hour
        add_header Cache-Control "public, max-age=3600";

        # CORS headers (allow feed readers from any origin)
        add_header Access-Control-Allow-Origin "*";
    }

    # Deny access to hidden files (except .well-known for certbot)
    location ~ /\.(?!well-known) {
        deny all;
    }

    # Deny access to sensitive files
    location ~ /\.(git|env|yaml)$ {
        deny all;
    }

    location ~ /venv/ {
        deny all;
    }

    location ~ /bin/ {
        deny all;
    }

    # Optional: Custom 404 page
    # error_page 404 /404.html;
    # location = /404.html {
    #     internal;
    # }
}
